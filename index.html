<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario & Incidencias Cloud Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, get } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxLmlqxw7vNHGiI4mjljUGgZQ5a2VPXuA",
            authDomain: "inventariopicking.firebaseapp.com",
            databaseURL: "https://inventariopicking-default-rtdb.firebaseio.com",
            projectId: "inventariopicking",
            storageBucket: "inventariopicking.firebasestorage.app",
            messagingSenderId: "92946062722",
            appId: "1:92946062722:web:b9f379d04c1d1d42d1039b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRefRegistros = ref(db, 'registros');
        const dbRefMaestro = ref(db, 'maestro');
        const dbRefIncidencias = ref(db, 'incidencias_global');

        let inventarioMaestro = [];

        onValue(dbRefMaestro, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                inventarioMaestro = Object.values(data);
                document.getElementById('sectionPicking').style.display = 'block';
                document.getElementById('uploadText').innerText = "‚úÖ SISTEMA CONECTADO";
            }
        });

        document.getElementById('inputExcel').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const rawRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                const nuevoMaestro = rawRows.slice(1).map(f => ({
                    cod: String(f[0] || '').trim(),
                    nom: String(f[1] || ''),
                    pos: String(f[2] || 'S/P'),
                    stock: parseFloat(f[3]) || 0
                })).filter(item => item.cod !== "");
                await set(dbRefMaestro, nuevoMaestro);
                alert("Maestro actualizado en nube.");
            };
        });

        document.getElementById('codigoBuscado').addEventListener('input', function() {
            const producto = inventarioMaestro.find(p => p.cod === this.value.trim());
            if (producto) {
                document.getElementById('resultadoBusqueda').style.display = 'block';
                document.getElementById('resNombre').innerText = producto.nom;
                document.getElementById('resPosicion').innerText = producto.pos;
                document.getElementById('resNombre').dataset.stock = producto.stock;
                document.getElementById('cantidadContada').focus();
            } else {
                document.getElementById('resultadoBusqueda').style.display = 'none';
            }
        });

        window.registrarEnNube = function() {
            const cant = document.getElementById('cantidadContada').value;
            if (!cant) return;
            push(dbRefRegistros, {
                cod: document.getElementById('codigoBuscado').value,
                nom: document.getElementById('resNombre').innerText,
                pos: document.getElementById('resPosicion').innerText,
                cant: cant,
                teorico: document.getElementById('resNombre').dataset.stock,
                fecha: new Date().toLocaleString()
            });
            document.getElementById('codigoBuscado').value = "";
            document.getElementById('cantidadContada').value = "";
            document.getElementById('resultadoBusqueda').style.display = 'none';
            document.getElementById('codigoBuscado').focus();
        };

        window.enviarIncidencia = function() {
            const texto = document.getElementById('txtIncidencia').value.trim();
            if (!texto) return;
            push(dbRefIncidencias, { comentario: texto, fecha: new Date().toLocaleString() });
            document.getElementById('txtIncidencia').value = "";
            cerrarModal();
        };

        onValue(dbRefRegistros, (snapshot) => { renderTabla(snapshot.val(), 'cuerpoRegistros'); });
        onValue(dbRefIncidencias, (snapshot) => { renderTablaInc(snapshot.val(), 'cuerpoIncidencias'); });

        function renderTabla(data, elementId) {
            const tabla = document.getElementById(elementId);
            tabla.innerHTML = "";
            if (data) {
                Object.keys(data).reverse().forEach(key => {
                    const item = data[key];
                    tabla.innerHTML += `<tr>
                        <td style="color:red; font-weight:bold;">${item.pos}</td>
                        <td>${item.nom}</td>
                        <td>${item.cant}</td>
                        <td><button class="btn-del" onclick="eliminarItem('registros/${key}')">üóëÔ∏è</button></td>
                    </tr>`;
                });
            }
        }

        function renderTablaInc(data, elementId) {
            const tabla = document.getElementById(elementId);
            tabla.innerHTML = "";
            if (data) {
                Object.keys(data).reverse().forEach(key => {
                    const item = data[key];
                    tabla.innerHTML += `<tr>
                        <td style="font-size:0.65rem; color:#666;">${item.fecha}</td>
                        <td style="color:#e67e22; font-weight:bold;">${item.comentario}</td>
                        <td><button class="btn-del" onclick="eliminarItem('incidencias_global/${key}')">üóëÔ∏è</button></td>
                    </tr>`;
                });
            }
        }

        window.copiarTabla = () => {
            let txt = "Caja\tProducto\tCant\n";
            const filas = document.getElementById('cuerpoRegistros').rows;
            for (let f of filas) txt += `${f.cells[0].innerText}\t${f.cells[1].innerText}\t${f.cells[2].innerText}\n`;
            navigator.clipboard.writeText(txt).then(() => alert("Tabla de Inventario copiada"));
        };

        window.exportarExcelTotal = async () => {
            const snapInv = await get(dbRefRegistros);
            const snapInc = await get(dbRefIncidencias);
            
            const wb = XLSX.utils.book_new();
            
            // Hoja Inventario
            if(snapInv.val()){
                const rowsInv = Object.values(snapInv.val()).map(i => ({
                    Caja: i.pos, C√≥digo: i.cod, Producto: i.nom, Cant: i.cant, Te√≥rico: i.teorico, Diferencia: i.cant - i.teorico, Fecha: i.fecha
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsInv), "Inventario");
            }
            
            // Hoja Incidencias
            if(snapInc.val()){
                const rowsInc = Object.values(snapInc.val()).map(i => ({ Fecha: i.fecha, Comentario: i.comentario }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsInc), "Incidencias");
            }
            
            XLSX.writeFile(wb, "Reporte_Completo_Nube.xlsx");
        };

        window.eliminarItem = (path) => { if(confirm("¬øEliminar?")) remove(ref(db, path)); };
        window.borrarTodo = () => { if(confirm("¬øBorrar historial de inventario?")) remove(dbRefRegistros); };
        window.abrirModal = () => document.getElementById('modalInc').style.display = 'flex';
        window.cerrarModal = () => document.getElementById('modalInc').style.display = 'none';
    </script>
    <style>
        :root { --primary: #1a73e8; --danger: #d93025; --warning: #f9ab00; --success: #34a853; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .upload-box { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-size: 0.75rem; color: #666; }
        input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .result-card { background: #f1f8ff; padding: 12px; border-radius: 8px; margin-top: 5px; }
        .ubicacion-valor { font-size: 2.2rem; font-weight: 800; color: var(--danger); text-align: center; display: block; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; }
        
        .nav-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-inc { background: var(--warning); color: black; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-copy { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-excel { background: var(--success); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; grid-column: span 2; }
        .btn-clear { background: none; border: none; color: #999; text-decoration: underline; font-size: 0.7rem; cursor: pointer; margin-top: 5px; }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:100; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 8px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .btn-del { border: none; background: none; color: #ccc; cursor: pointer; font-size: 1rem; }
        .section-title { font-size: 0.85rem; font-weight: bold; color: #333; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="upload-box" onclick="document.getElementById('inputExcel').click()">
        <p id="uploadText">üìÇ Sincronizar Maestro Excel</p>
        <input type="file" id="inputExcel" accept=".xlsx, .xls" style="display:none">
    </div>

    <div id="sectionPicking" style="display:none;">
        <input type="text" id="codigoBuscado" inputmode="numeric" placeholder="Escanear C√≥digo..." autocomplete="off">
        <div id="resultadoBusqueda" class="result-card" style="display:none;">
            <div id="resNombre" style="font-weight:bold; font-size:0.85rem"></div>
            <span class="ubicacion-valor" id="resPosicion"></span>
            <input type="number" id="cantidadContada" inputmode="numeric" placeholder="Cantidad">
            <button onclick="registrarEnNube()" class="btn-main">CONFIRMAR REGISTRO</button>
        </div>
    </div>

    <div class="nav-actions">
        <button class="btn-copy" onclick="copiarTabla()">üìã Copiar Tabla</button>
        <button class="btn-inc" onclick="abrirModal()">‚ö†Ô∏è Incidencia</button>
        <button class="btn-excel" onclick="exportarExcelTotal()">üíæ Descargar Reporte Excel</button>
    </div>
    <center><button class="btn-clear" onclick="borrarTodo()">Borrar historial de inventario</button></center>
</div>

<div class="container">
    <div class="section-title">üì¶ Historial de Conteo</div>
    <table>
        <tbody id="cuerpoRegistros"></tbody>
    </table>
</div>

<div class="container">
    <div class="section-title">üö© Incidencias / Comentarios</div>
    <table>
        <tbody id="cuerpoIncidencias"></tbody>
    </table>
</div>

<div class="modal" id="modalInc">
    <div class="modal-content">
        <h3 style="margin-top:0">Nueva Incidencia</h3>
        <textarea id="txtIncidencia" style="width:100%; height:100px; border:1px solid #ddd; border-radius:6px; padding:10px; font-family:inherit;" placeholder="Describe la incidencia o comentario..."></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-main" onclick="enviarIncidencia()">Guardar</button>
            <button class="btn-copy" style="width:100%" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    document.getElementById('cantidadContada').addEventListener('keydown', (e) => { if(e.key === 'Enter') registrarEnNube(); });
</script>

</body>
</html>
