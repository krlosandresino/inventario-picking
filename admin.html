<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Admin - Picking</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxLmlqxw7vNHGiI4mjljUGgZQ5a2VPXuA",
            authDomain: "inventariopicking.firebaseapp.com",
            databaseURL: "https://inventariopicking-default-rtdb.firebaseio.com",
            projectId: "inventariopicking",
            storageBucket: "inventariopicking.firebasestorage.app",
            messagingSenderId: "92946062722",
            appId: "1:92946062722:web:b9f379d04c1d1d42d1039b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRefRegistros = ref(db, 'registros');
        const dbRefMaestro = ref(db, 'maestro');
        const dbRefIncidencias = ref(db, 'incidencias_global');

        let dataMaestro = [];

        window.validarAcceso = () => {
            const user = document.getElementById('userLog').value.toLowerCase();
            const pass = document.getElementById('passLog').value;
            if (user === "oriflame" && pass === "2026") {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminMain').style.display = 'block';
            } else { alert("Acceso Incorrecto"); }
        };

        onValue(dbRefMaestro, (snapshot) => {
            dataMaestro = snapshot.val() || [];
            document.getElementById('totalMaestro').innerText = dataMaestro.length;
        });

        onValue(dbRefRegistros, (snapshot) => {
            renderMonitorAgrupado(snapshot.val() || {});
        });

        onValue(dbRefIncidencias, (snapshot) => {
            const lista = Object.values(snapshot.val() || {}).reverse();
            document.getElementById('countInc').innerText = lista.length;
            document.getElementById('bodyIncidencias').innerHTML = lista.map(inc => `
                <tr>
                    <td style="width:20%; color:#888;">${inc.fecha.split(',')[1] || inc.fecha}</td>
                    <td><b>${inc.usuario}</b></td>
                    <td style="color:#e71d36; font-weight:bold">${inc.comentario}</td>
                </tr>
            `).join('');
        });

        function renderMonitorAgrupado(registros) {
            const listaRaw = Object.values(registros);
            const agrupados = {};
            listaRaw.forEach(reg => {
                if (!agrupados[reg.cod]) {
                    agrupados[reg.cod] = { ...reg, cant: 0, usuarios: new Set() };
                }
                agrupados[reg.cod].cant += parseFloat(reg.cant || 0);
                agrupados[reg.cod].usuarios.add(reg.usuario);
            });
            const listaFinal = Object.values(agrupados).reverse();
            document.getElementById('bodyMonitor').innerHTML = listaFinal.map(reg => {
                const teo = parseFloat(reg.teorico || 0);
                const fis = reg.cant;
                const dif = fis - teo;
                const colorDif = dif === 0 ? '#2ec4b6' : (dif < 0 ? '#e71d36' : '#4361ee');
                return `
                    <tr>
                        <td><span class="user-pill">${Array.from(reg.usuarios).join(', ')}</span></td>
                        <td>${reg.cod}</td>
                        <td><b style="color:#4361ee">${reg.pos}</b></td>
                        <td align="center">${teo}</td>
                        <td align="center"><b>${fis}</b></td>
                        <td align="center" style="color:${colorDif}; font-weight:bold;">${dif > 0 ? '+'+dif : dif}</td>
                    </tr>`;
            }).join('');
            document.getElementById('pendientes').innerText = (dataMaestro.length - Object.keys(agrupados).length);
        }

        window.exportarExcelTotal = async () => {
            const snapInv = await get(dbRefRegistros);
            const snapInc = await get(dbRefIncidencias);
            const wb = XLSX.utils.book_new();
            
            if(snapInv.val()){
                const data = snapInv.val();
                const agrupados = {};
                Object.values(data).forEach(i => {
                    if(!agrupados[i.cod]) agrupados[i.cod] = { ...i, cant: 0, listaUsuarios: new Set() };
                    agrupados[i.cod].cant += parseFloat(i.cant || 0);
                    agrupados[i.cod].listaUsuarios.add(i.usuario);
                });
                const rows = Object.values(agrupados).map(i => ({ 
                    Ubicacion: i.pos, Codigo: i.cod, Producto: i.nom, Stock: i.teorico, 
                    Encontrados: i.cant, Diferencia: i.cant - (i.teorico || 0),
                    Operadores: Array.from(i.listaUsuarios).join(', ')
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "REPORTE PL");
            }

            if(snapInc.val()){
                const rowsInc = Object.values(snapInc.val()).map(i => ({
                    Fecha: i.fecha, 
                    Operador: i.usuario, 
                    Codigo: i.detalles ? i.detalles.cod : '', 
                    Ubicacion: i.detalles ? i.detalles.pos : '', 
                    Cantidad: i.detalles ? i.detalles.cant : ''
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsInc), "FUERA DE STOCK");
            }
            
            XLSX.writeFile(wb, "REPORTE INVENTARIO PL.xlsx");
        };

        window.subirExcel = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const rawRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                const nuevoMaestro = rawRows.slice(1).map(f => ({ cod: String(f[0]||''), nom: String(f[1]||''), pos: String(f[2]||''), stock: parseFloat(f[3])||0 })).filter(i => i.cod !== "");
                await set(dbRefMaestro, nuevoMaestro);
                alert("Inventario cargado");
            };
        };

        window.borrarHistorial = async () => {
            if(confirm("¬øDESEAS BORRAR TODA LA INFORMACION?")) {
                await remove(dbRefRegistros);
                await remove(dbRefIncidencias);
                alert("Datos limpiados correctamente.");
            }
        };
    </script>
    <style>
        :root { --primary: #4361ee; --bg: #f4f7fe; --danger: #e71d36; --success: #2ec4b6; --warning: #f9ab00; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, #4361ee, #3a0ca3); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); width: 350px; text-align: center; }
        .login-card input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn-login { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; border-bottom: 6px solid var(--primary); }
        .stat-card h2 { margin: 10px 0 0 0; font-size: 3rem; }
        .main-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; }
        .section { background: white; border-radius: 15px; padding: 25px; }
        .scroll { max-height: 450px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f9fafb; padding: 15px; text-align: left; color: #777; border-bottom: 2px solid #eee; font-size: 0.8rem; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .user-pill { background: #eef2ff; color: var(--primary); padding: 4px 10px; border-radius: 15px; font-weight: bold; font-size: 0.75rem; }
        .btn-blue { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <i class="fa-solid fa-circle-user" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 10px;"></i>
        <h2>Admin</h2>
        <input type="text" id="userLog" placeholder="Usuario">
        <input type="password" id="passLog" placeholder="Contrase√±a">
        <button class="btn-login" onclick="validarAcceso()">ENTRAR</button>
    </div>
</div>

<div id="adminMain" style="display:none;">
    <div class="header">
        <h1 style="margin:0;">üõ†Ô∏è Gesti√≥n Inventario Picking</h1>
        <div style="display:flex; gap:10px;">
            <button class="btn-blue" onclick="document.getElementById('inputExcel').click()">CARGAR INVENTARIO</button>
            <button class="btn-blue btn-success" onclick="exportarExcelTotal()">DESCARGAR REPORTE</button>
            <button class="btn-blue btn-danger" onclick="borrarHistorial()">REINICIAR SISTEMA</button>
            <input type="file" id="inputExcel" accept=".xlsx" style="display:none" onchange="subirExcel(event)">
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><span>SKU</span><h2 id="totalMaestro">0</h2></div>
        <div class="stat-card" style="border-color: var(--warning);"><span>PENDIENTES</span><h2 id="pendientes">0</h2></div>
        <div class="stat-card" style="border-color: var(--danger);"><span>Fuera de Stock</span><h2 id="countInc">0</h2></div>
    </div>

    <div class="main-grid">
        <div class="section">
            <h3>Monitoreo operador</h3>
            <div class="scroll">
                <table>
                    <thead><tr><th>Operadores</th><th>C√≥digo</th><th>Ubicaci√≥n</th><th>Stock</th><th>Encontrados</th><th>Dif.</th></tr></thead>
                    <tbody id="bodyMonitor"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3>Alertas Fuera de Stock</h3>
            <div class="scroll">
                <table>
                    <thead><tr><th>Hora</th><th>Op.</th><th>Reporte</th></tr></thead>
                    <tbody id="bodyIncidencias"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('userLog').addEventListener('keydown', (e) => { if(e.key === 'Enter') document.getElementById('passLog').focus(); });
    document.getElementById('passLog').addEventListener('keydown', (e) => { if(e.key === 'Enter') validarAcceso(); });
</script>
</body>
</html>